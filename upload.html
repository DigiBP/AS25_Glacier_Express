<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Prescription Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      padding: 24px 20px;
      max-width: 420px;
      width: 100%;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 20px;
    }

    p {
      margin: 0 0 10px;
      font-size: 14px;
      color: #4b5563;
    }

    .file-row {
      margin: 12px 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    input[type="file"] {
      font-size: 13px;
    }

    button {
      margin-top: 6px;
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      background: #2563eb;
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .status {
      margin-top: 12px;
      font-size: 13px;
      color: #4b5563;
      white-space: pre-wrap;
    }

    .status strong {
      display: block;
      margin-bottom: 4px;
    }

    .small {
      font-size: 11px;
      color: #6b7280;
      margin-top: 8px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
      font-size: 11px;
      margin-top: 4px;
    }

    code {
      background: #f3f4f6;
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 12px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Upload Prescription</h1>
  <p>
    Choose an image or PDF of your prescription. Weâ€™ll extract the text and
    send it back to your chatbot conversation.
  </p>

  <div class="file-row">
    <input id="file-input" type="file" accept="image/*,.pdf" />
    <button id="upload-btn" type="button">ðŸ“„ Upload & Send</button>
  </div>

  <div id="status" class="status">
    <strong>Waiting for fileâ€¦</strong>
    Then this page will run OCR and notify the chatbot automatically.
  </div>

  <p class="small">
    This demo uses <span class="tag">OCR.space API</span> and the
    <span class="tag">Voiceflow Conversational API</span>.<br />
    In a real production system, youâ€™d hide API keys on a backend.
  </p>

  <p class="small">
    If you came here from the chatbot, a <code>userId</code> is in the link,
    like <code>?userId=student-demo</code>.
  </p>
</div>

<script>
  /***********************
   * ðŸ”‘ CONFIG â€“ EDIT THESE
   ***********************/
  const OCR_API_KEY = "YOUR_OCR_SPACE_API_KEY";       // from https://ocr.space/OCRAPI
  const VOICEFLOW_API_KEY = "YOUR_VOICEFLOW_API_KEY"; // VF.DM.xxxxx â€“ Dialog/Runtime API key
  const VOICEFLOW_VERSION_ID = "production";          // or a specific version ID

  /***********************
   * Helpers
   ***********************/
  const fileInput = document.getElementById("file-input");
  const uploadBtn = document.getElementById("upload-btn");
  const statusBox = document.getElementById("status");

  function setStatus(text, isError = false) {
    statusBox.innerHTML =
      "<strong>" + (isError ? "Error" : "Status") + ":</strong>\n" + text;
    statusBox.style.color = isError ? "#b91c1c" : "#4b5563";
  }

  function setLoading(isLoading) {
    uploadBtn.disabled = isLoading;
    uploadBtn.textContent = isLoading ? "â³ Processingâ€¦" : "ðŸ“„ Upload & Send";
  }

  // Get userId from ?userId=... in the URL, fallback to a default
  function getUserId() {
    const params = new URLSearchParams(window.location.search);
    return params.get("userId") || "student-demo-user";
  }

  /***********************
   * OCR.space call
   ***********************/
  async function runOCR(file) {
    const formData = new FormData();
    formData.append("file", file);
    formData.append("apikey", OCR_API_KEY);
    formData.append("language", "eng");
    formData.append("isTable", "true");
    formData.append("isOverlayRequired", "false");

    const response = await fetch("https://api.ocr.space/parse/image", {
      method: "POST",
      body: formData
    });

    const data = await response.json();
    if (data.IsErroredOnProcessing) {
      throw new Error(data.ErrorMessage || "OCR processing error");
    }

    const firstResult =
      data.ParsedResults && data.ParsedResults.length > 0
        ? data.ParsedResults[0]
        : null;

    if (!firstResult || !firstResult.ParsedText) {
      throw new Error("No text found in OCR result");
    }

    return firstResult.ParsedText.trim();
  }

  /***********************
   * Voiceflow call
   ***********************/
  async function sendToVoiceflow(userId, text) {
    const response = await fetch(
      "https://general-runtime.voiceflow.com/state/user/" +
        encodeURIComponent(userId) +
        "/interact",
      {
        method: "POST",
        headers: {
          "Authorization": VOICEFLOW_API_KEY,
          "Content-Type": "application/json",
          "versionID": VOICEFLOW_VERSION_ID
        },
        body: JSON.stringify({
          request: {
            type: "text",
            payload: text
          }
        })
      }
    );

    if (!response.ok) {
      const body = await response.text();
      throw new Error("Voiceflow error: " + response.status + " â€“ " + body);
    }

    // You *could* inspect traces here for debugging if you want
    await response.json();
  }

  /***********************
   * Main upload handler
   ***********************/
  uploadBtn.addEventListener("click", async () => {
    const file = fileInput.files && fileInput.files[0];
    if (!file) {
      alert("Please choose an image or PDF first.");
      return;
    }

    const userId = getUserId();
    setLoading(true);
    setStatus(
      "Uploading file and running OCRâ€¦\nUser ID: " + userId +
      "\nThis may take a few seconds."
    );

    try {
      const extracted = await runOCR(file);

      setStatus(
        "OCR successful.\n\nA summary of what we extracted:\n\n" +
        (extracted.slice(0, 400) + (extracted.length > 400 ? "â€¦" : "")) +
        "\n\nNow sending this back to your chatbot conversationâ€¦"
      );

      const wrappedMessage =
        "Here is my prescription information (from the upload link):\n\n" +
        extracted;

      await sendToVoiceflow(userId, wrappedMessage);

      setStatus(
        "âœ… Done!\n\nThe prescription text has been sent to your chatbot.\n" +
        "You can now return to the chat window and continue."
      );
    } catch (err) {
      console.error(err);
      setStatus(
        "Something went wrong.\n\nDetails: " + err.message +
        "\n\nCheck your API keys, file type, and internet connection.",
        true
      );
    } finally {
      setLoading(false);
    }
  });

  // Initial status
  setStatus(
    "Waiting for fileâ€¦\n\nMake sure the link includes ?userId=YOUR_USER_ID so " +
    "the upload goes to the right conversation."
  );
</script>
</body>
</html>
